var async = require('async')

module.exports = function (grunt) {
// Project configuration.
  grunt.initConfig({
    mochaTest: {
      src: 'test/integration/*',
      options: {
        timeout: 30000
      }
    }
  })

// Test Setup
  grunt.registerTask('createTestData', function () {
    var cb = this.async()
    var config = require('./conf/local').connectors['appc.oracledb']
    var OracleDB = require('oracledb')

    OracleDB.getConnection(config, function (err, connection) {
      if (err) {
        cb(err)
      } else {
        async.eachSeries([
          'DROP TABLE TEST_Post PURGE',
          'CREATE TABLE TEST_Post (' +
        ' id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,' +
        ' title VARCHAR2(255),' +
        ' content VARCHAR2(255),' +
        ' CONSTRAINT test_post_id PRIMARY KEY (id)' +
        ')',
          'DROP TABLE TEST_Category PURGE',
          'CREATE TABLE TEST_Category (' +
        ' id NUMBER,' +
        ' category VARCHAR2(255)' +
        ')'
        ],
        function (sql, next) {
          connection.execute(
            sql,
            function (err, results) {
              if (results && results.rows) {
                console.log(results.rows)
              }
              if (err) {
                console.log(err)
              }
              next()
            })
        },
        cb)
      }
    })
  })

// Load grunt plugins for modules.
  grunt.loadNpmTasks('grunt-mocha-test')

// Register tasks.
  grunt.registerTask('default', ['createTestData', 'mochaTest'])
}
